<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE UndecidableInstances #-}</span><span>
</span><span id="line-2"></span><span>
</span><span id="line-3"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Hydra.API.Server</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-4"></span><span>
</span><span id="line-5"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Hydra.Prelude</span></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">TVar</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">readTVar</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Prim.html#seq"><span class="hs-identifier">seq</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-6"></span><span>
</span><span id="line-7"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Cardano.Ledger.Core</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">PParams</span></span><span class="hs-special">)</span><span>
</span><span id="line-8"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Concurrent.MVar.html"><span class="hs-identifier">Control.Concurrent.MVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.MVar.html#newEmptyMVar"><span class="hs-identifier">newEmptyMVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.MVar.html#putMVar"><span class="hs-identifier">putMVar</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.MVar.html#takeMVar"><span class="hs-identifier">takeMVar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-9"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/stm-2.5.1.0/src/Control.Concurrent.STM.TChan.html"><span class="hs-identifier">Control.Concurrent.STM.TChan</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/stm-2.5.1.0/src/Control.Concurrent.STM.TChan.html#newBroadcastTChanIO"><span class="hs-identifier">newBroadcastTChanIO</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/stm-2.5.1.0/src/Control.Concurrent.STM.TChan.html#writeTChan"><span class="hs-identifier">writeTChan</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-10"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/stm-2.5.1.0/src/Control.Concurrent.STM.TVar.html"><span class="hs-identifier">Control.Concurrent.STM.TVar</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/stm-2.5.1.0/src/Control.Concurrent.STM.TVar.html#modifyTVar%27"><span class="hs-identifier">modifyTVar'</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Conc.Sync.html#newTVarIO"><span class="hs-identifier">newTVarIO</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-11"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Control.Exception.html"><span class="hs-identifier">Control.Exception</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IO.Exception.html#IOException"><span class="hs-identifier">IOException</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-12"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hydra.API.APIServerLog.html"><span class="hs-identifier">Hydra.API.APIServerLog</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hydra.API.APIServerLog.html#APIServerLog"><span class="hs-identifier">APIServerLog</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-13"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hydra.API.ClientInput.html"><span class="hs-identifier">Hydra.API.ClientInput</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hydra.API.ClientInput.html#ClientInput"><span class="hs-identifier">ClientInput</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-14"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hydra.API.HTTPServer.html"><span class="hs-identifier">Hydra.API.HTTPServer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hydra.API.HTTPServer.html#httpApp"><span class="hs-identifier">httpApp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-15"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hydra.API.Projection.html"><span class="hs-identifier">Hydra.API.Projection</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hydra.API.Projection.html#Projection"><span class="hs-identifier">Projection</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hydra.API.Projection.html#mkProjection"><span class="hs-identifier">mkProjection</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-16"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hydra.API.ServerOutput.html"><span class="hs-identifier">Hydra.API.ServerOutput</span></a></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-17"></span><span>  </span><span class="annot"><a href="Hydra.API.ServerOutput.html#HeadStatus"><span class="hs-identifier">HeadStatus</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hydra.API.ServerOutput.html#Idle"><span class="hs-identifier">Idle</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-18"></span><span>  </span><span class="annot"><a href="Hydra.API.ServerOutput.html#ServerOutput"><span class="hs-identifier">ServerOutput</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-19"></span><span>  </span><span class="annot"><a href="Hydra.API.ServerOutput.html#TimedServerOutput"><span class="hs-identifier">TimedServerOutput</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-20"></span><span>  </span><span class="annot"><a href="Hydra.API.ServerOutput.html#projectHeadStatus"><span class="hs-identifier">projectHeadStatus</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-21"></span><span>  </span><span class="annot"><a href="Hydra.API.ServerOutput.html#projectInitializingHeadId"><span class="hs-identifier">projectInitializingHeadId</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-22"></span><span>  </span><span class="annot"><a href="Hydra.API.ServerOutput.html#projectSnapshotUtxo"><span class="hs-identifier">projectSnapshotUtxo</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-23"></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-24"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hydra.API.WSServer.html"><span class="hs-identifier">Hydra.API.WSServer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hydra.API.WSServer.html#nextSequenceNumber"><span class="hs-identifier">nextSequenceNumber</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hydra.API.WSServer.html#wsApp"><span class="hs-identifier">wsApp</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Hydra.Cardano.Api</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">LedgerEra</span></span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hydra.Chain.html"><span class="hs-identifier">Hydra.Chain</span></a></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-27"></span><span>  </span><span class="annot"><a href="Hydra.Chain.html#Chain"><span class="hs-identifier">Chain</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span>
</span><span id="line-28"></span><span>  </span><span class="annot"><a href="Hydra.Chain.html#IsChainState"><span class="hs-identifier">IsChainState</span></a></span><span class="hs-special">,</span><span>
</span><span id="line-29"></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hydra.Chain.Direct.State.html"><span class="hs-identifier">Hydra.Chain.Direct.State</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hydra.Logging.html"><span class="hs-identifier">Hydra.Logging</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">Tracer</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">traceWith</span></span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hydra.Network.html"><span class="hs-identifier">Hydra.Network</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">IP</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">PortNumber</span></span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hydra.Party.html"><span class="hs-identifier">Hydra.Party</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hydra.Party.html#Party"><span class="hs-identifier">Party</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="Hydra.Persistence.html"><span class="hs-identifier">Hydra.Persistence</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hydra.Persistence.html#PersistenceIncremental"><span class="hs-identifier">PersistenceIncremental</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-35"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.Wai.Handler.Warp</span></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-36"></span><span>  </span><span class="annot"><span class="hs-identifier">defaultSettings</span></span><span class="hs-special">,</span><span>
</span><span id="line-37"></span><span>  </span><span class="annot"><span class="hs-identifier">runSettings</span></span><span class="hs-special">,</span><span>
</span><span id="line-38"></span><span>  </span><span class="annot"><span class="hs-identifier">setBeforeMainLoop</span></span><span class="hs-special">,</span><span>
</span><span id="line-39"></span><span>  </span><span class="annot"><span class="hs-identifier">setHost</span></span><span class="hs-special">,</span><span>
</span><span id="line-40"></span><span>  </span><span class="annot"><span class="hs-identifier">setOnException</span></span><span class="hs-special">,</span><span>
</span><span id="line-41"></span><span>  </span><span class="annot"><span class="hs-identifier">setPort</span></span><span class="hs-special">,</span><span>
</span><span id="line-42"></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.Wai.Handler.WebSockets</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier">websocketsOr</span></span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Network.WebSockets</span></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-45"></span><span>  </span><span class="annot"><span class="hs-identifier">defaultConnectionOptions</span></span><span class="hs-special">,</span><span>
</span><span id="line-46"></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-47"></span><span>
</span><span id="line-48"></span><span class="annot"><span class="hs-comment">-- | Handle to provide a means for sending server outputs to clients.</span></span><span>
</span><span id="line-49"></span><span class="hs-keyword">newtype</span><span> </span><span id="Server"><span class="annot"><a href="Hydra.API.Server.html#Server"><span class="hs-identifier hs-var">Server</span></a></span></span><span> </span><span id="local-6989586621680250324"><span class="annot"><a href="#local-6989586621680250324"><span class="hs-identifier hs-type">tx</span></a></span></span><span> </span><span id="local-6989586621680250325"><span class="annot"><a href="#local-6989586621680250325"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Server"><span class="annot"><a href="Hydra.API.Server.html#Server"><span class="hs-identifier hs-var">Server</span></a></span></span><span>
</span><span id="line-50"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="%24sel%3AsendOutput%3AServer"><span class="annot"><span class="annottext">forall tx (m :: * -&gt; *). Server tx m -&gt; ServerOutput tx -&gt; m ()
</span><a href="Hydra.API.Server.html#%24sel%3AsendOutput%3AServer"><span class="hs-identifier hs-var hs-var">sendOutput</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Hydra.API.ServerOutput.html#ServerOutput"><span class="hs-identifier hs-type">ServerOutput</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680250324"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680250325"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span>  </span><span class="annot"><span class="hs-comment">-- ^ Send some output to all connected clients.</span></span><span>
</span><span id="line-52"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-53"></span><span>
</span><span id="line-54"></span><span class="annot"><span class="hs-comment">-- | Callback for receiving client inputs.</span></span><span>
</span><span id="line-55"></span><span class="hs-keyword">type</span><span> </span><span id="ServerCallback"><span class="annot"><a href="Hydra.API.Server.html#ServerCallback"><span class="hs-identifier hs-var">ServerCallback</span></a></span></span><span> </span><span id="local-6989586621680250473"><span class="annot"><a href="#local-6989586621680250473"><span class="hs-identifier hs-type">tx</span></a></span></span><span> </span><span id="local-6989586621680250474"><span class="annot"><a href="#local-6989586621680250474"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Hydra.API.ClientInput.html#ClientInput"><span class="hs-identifier hs-type">ClientInput</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680250473"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680250474"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-56"></span><span>
</span><span id="line-57"></span><span class="annot"><span class="hs-comment">-- | A type tying both receiving input and sending output into a /Component/.</span></span><span>
</span><span id="line-58"></span><span class="hs-keyword">type</span><span> </span><span id="ServerComponent"><span class="annot"><a href="Hydra.API.Server.html#ServerComponent"><span class="hs-identifier hs-var">ServerComponent</span></a></span></span><span> </span><span id="local-6989586621680250475"><span class="annot"><a href="#local-6989586621680250475"><span class="hs-identifier hs-type">tx</span></a></span></span><span> </span><span id="local-6989586621680250476"><span class="annot"><a href="#local-6989586621680250476"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span id="local-6989586621680250477"><span class="annot"><a href="#local-6989586621680250477"><span class="hs-identifier hs-type">a</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Hydra.API.Server.html#ServerCallback"><span class="hs-identifier hs-type">ServerCallback</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680250475"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680250476"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hydra.API.Server.html#Server"><span class="hs-identifier hs-type">Server</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680250475"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680250476"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680250476"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680250477"><span class="hs-identifier hs-type">a</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621680250476"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680250477"><span class="hs-identifier hs-type">a</span></a></span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span class="annot"><a href="Hydra.API.Server.html#withAPIServer"><span class="hs-identifier hs-type">withAPIServer</span></a></span><span> </span><span class="hs-glyph">::</span><span>
</span><span id="line-61"></span><span>  </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621680250330"><span class="annot"><a href="#local-6989586621680250330"><span class="hs-identifier hs-type">tx</span></a></span></span><span class="hs-operator">.</span><span>
</span><span id="line-62"></span><span>  </span><span class="annot"><a href="Hydra.Chain.html#IsChainState"><span class="hs-identifier hs-type">IsChainState</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680250330"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-63"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">IP</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-64"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">PortNumber</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-65"></span><span>  </span><span class="annot"><a href="Hydra.Party.html#Party"><span class="hs-identifier hs-type">Party</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-66"></span><span>  </span><span class="annot"><a href="Hydra.Persistence.html#PersistenceIncremental"><span class="hs-identifier hs-type">PersistenceIncremental</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hydra.API.ServerOutput.html#TimedServerOutput"><span class="hs-identifier hs-type">TimedServerOutput</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680250330"><span class="hs-identifier hs-type">tx</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-67"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">Tracer</span></span><span> </span><span class="annot"><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="annot"><a href="Hydra.API.APIServerLog.html#APIServerLog"><span class="hs-identifier hs-type">APIServerLog</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-68"></span><span>  </span><span class="annot"><a href="Hydra.Chain.html#Chain"><span class="hs-identifier hs-type">Chain</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680250330"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-69"></span><span>  </span><span class="annot"><span class="hs-identifier hs-type">PParams</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">LedgerEra</span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-70"></span><span>  </span><span class="annot"><a href="Hydra.API.Server.html#ServerComponent"><span class="hs-identifier hs-type">ServerComponent</span></a></span><span> </span><span class="annot"><a href="#local-6989586621680250330"><span class="hs-identifier hs-type">tx</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span id="withAPIServer"><span class="annot"><span class="annottext">withAPIServer :: forall tx.
IsChainState tx =&gt;
IP
-&gt; PortNumber
-&gt; Party
-&gt; PersistenceIncremental (TimedServerOutput tx) IO
-&gt; Tracer IO APIServerLog
-&gt; Chain tx IO
-&gt; PParams LedgerEra
-&gt; ServerComponent tx IO ()
</span><a href="Hydra.API.Server.html#withAPIServer"><span class="hs-identifier hs-var hs-var">withAPIServer</span></a></span></span><span> </span><span id="local-6989586621680250547"><span class="annot"><span class="annottext">IP
</span><a href="#local-6989586621680250547"><span class="hs-identifier hs-var">host</span></a></span></span><span> </span><span id="local-6989586621680250548"><span class="annot"><span class="annottext">PortNumber
</span><a href="#local-6989586621680250548"><span class="hs-identifier hs-var">port</span></a></span></span><span> </span><span id="local-6989586621680250549"><span class="annot"><span class="annottext">Party
</span><a href="#local-6989586621680250549"><span class="hs-identifier hs-var">party</span></a></span></span><span> </span><span class="annot"><a href="Hydra.Persistence.html#PersistenceIncremental"><span class="hs-identifier hs-type">PersistenceIncremental</span></a></span><span class="hs-special">{</span><span id="local-6989586621680250551"><span class="annot"><span class="annottext">FromJSON (TimedServerOutput tx) =&gt; IO [TimedServerOutput tx]
loadAll :: FromJSON (TimedServerOutput tx) =&gt; IO [TimedServerOutput tx]
$sel:loadAll:PersistenceIncremental :: forall a (m :: * -&gt; *).
PersistenceIncremental a m -&gt; FromJSON a =&gt; m [a]
</span><a href="#local-6989586621680250551"><span class="hs-identifier hs-var hs-var">loadAll</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680250553"><span class="annot"><span class="annottext">ToJSON (TimedServerOutput tx) =&gt; TimedServerOutput tx -&gt; IO ()
append :: ToJSON (TimedServerOutput tx) =&gt; TimedServerOutput tx -&gt; IO ()
$sel:append:PersistenceIncremental :: forall a (m :: * -&gt; *).
PersistenceIncremental a m -&gt; ToJSON a =&gt; a -&gt; m ()
</span><a href="#local-6989586621680250553"><span class="hs-identifier hs-var hs-var">append</span></a></span></span><span class="hs-special">}</span><span> </span><span id="local-6989586621680250555"><span class="annot"><span class="annottext">Tracer IO APIServerLog
</span><a href="#local-6989586621680250555"><span class="hs-identifier hs-var">tracer</span></a></span></span><span> </span><span id="local-6989586621680250556"><span class="annot"><span class="annottext">Chain tx IO
</span><a href="#local-6989586621680250556"><span class="hs-identifier hs-var">chain</span></a></span></span><span> </span><span id="local-6989586621680250557"><span class="annot"><span class="annottext">PParams LedgerEra
</span><a href="#local-6989586621680250557"><span class="hs-identifier hs-var">pparams</span></a></span></span><span> </span><span id="local-6989586621680250558"><span class="annot"><span class="annottext">ServerCallback tx IO
</span><a href="#local-6989586621680250558"><span class="hs-identifier hs-var">callback</span></a></span></span><span> </span><span id="local-6989586621680250559"><span class="annot"><span class="annottext">Server tx IO -&gt; IO ()
</span><a href="#local-6989586621680250559"><span class="hs-identifier hs-var">action</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-72"></span><span>  </span><span class="annot"><span class="annottext">(IOException -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall e a. Exception e =&gt; (e -&gt; IO a) -&gt; IO a -&gt; IO a
forall (m :: * -&gt; *) e a.
(MonadCatch m, Exception e) =&gt;
(e -&gt; m a) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">handle</span></span><span> </span><span class="annot"><span class="annottext">IOException -&gt; IO ()
</span><a href="#local-6989586621680250561"><span class="hs-identifier hs-var">onIOException</span></a></span><span> </span><span class="annot"><span class="annottext">(IO () -&gt; IO ()) -&gt; IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-73"></span><span>    </span><span id="local-6989586621680250562"><span class="annot"><span class="annottext">TChan (TimedServerOutput tx)
</span><a href="#local-6989586621680250562"><span class="hs-identifier hs-var">responseChannel</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (TChan (TimedServerOutput tx))
forall a. IO (TChan a)
</span><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/stm-2.5.1.0/src/Control.Concurrent.STM.TChan.html#newBroadcastTChanIO"><span class="hs-identifier hs-var">newBroadcastTChanIO</span></a></span><span>
</span><span id="line-74"></span><span>    </span><span id="local-6989586621680250563"><span class="annot"><span class="annottext">[TimedServerOutput tx]
</span><a href="#local-6989586621680250563"><span class="hs-identifier hs-var">timedOutputEvents</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO [TimedServerOutput tx]
FromJSON (TimedServerOutput tx) =&gt; IO [TimedServerOutput tx]
</span><a href="#local-6989586621680250551"><span class="hs-identifier hs-var">loadAll</span></a></span><span>
</span><span id="line-75"></span><span>
</span><span id="line-76"></span><span>    </span><span class="hs-comment">-- Intialize our read model from stored events</span><span>
</span><span id="line-77"></span><span>    </span><span id="local-6989586621680250564"><span class="annot"><span class="annottext">Projection STM (ServerOutput tx) HeadStatus
</span><a href="#local-6989586621680250564"><span class="hs-identifier hs-var">headStatusP</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">HeadStatus
-&gt; [ServerOutput tx]
-&gt; (HeadStatus -&gt; ServerOutput tx -&gt; HeadStatus)
-&gt; IO (Projection (STM IO) (ServerOutput tx) HeadStatus)
forall (m :: * -&gt; *) model event.
MonadSTM m =&gt;
model
-&gt; [event]
-&gt; (model -&gt; event -&gt; model)
-&gt; m (Projection (STM m) event model)
</span><a href="Hydra.API.Projection.html#mkProjection"><span class="hs-identifier hs-var">mkProjection</span></a></span><span> </span><span class="annot"><span class="annottext">HeadStatus
</span><a href="Hydra.API.ServerOutput.html#Idle"><span class="hs-identifier hs-var">Idle</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TimedServerOutput tx -&gt; ServerOutput tx
forall tx. TimedServerOutput tx -&gt; ServerOutput tx
</span><a href="Hydra.API.ServerOutput.html#%24sel%3Aoutput%3ATimedServerOutput"><span class="hs-identifier hs-var">output</span></a></span><span> </span><span class="annot"><span class="annottext">(TimedServerOutput tx -&gt; ServerOutput tx)
-&gt; [TimedServerOutput tx] -&gt; [ServerOutput tx]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[TimedServerOutput tx]
</span><a href="#local-6989586621680250563"><span class="hs-identifier hs-var">timedOutputEvents</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HeadStatus -&gt; ServerOutput tx -&gt; HeadStatus
forall tx. HeadStatus -&gt; ServerOutput tx -&gt; HeadStatus
</span><a href="Hydra.API.ServerOutput.html#projectHeadStatus"><span class="hs-identifier hs-var">projectHeadStatus</span></a></span><span>
</span><span id="line-78"></span><span>    </span><span id="local-6989586621680250567"><span class="annot"><span class="annottext">Projection STM (ServerOutput tx) (Maybe (UTxOType tx))
</span><a href="#local-6989586621680250567"><span class="hs-identifier hs-var">snapshotUtxoP</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (UTxOType tx)
-&gt; [ServerOutput tx]
-&gt; (Maybe (UTxOType tx) -&gt; ServerOutput tx -&gt; Maybe (UTxOType tx))
-&gt; IO (Projection (STM IO) (ServerOutput tx) (Maybe (UTxOType tx)))
forall (m :: * -&gt; *) model event.
MonadSTM m =&gt;
model
-&gt; [event]
-&gt; (model -&gt; event -&gt; model)
-&gt; m (Projection (STM m) event model)
</span><a href="Hydra.API.Projection.html#mkProjection"><span class="hs-identifier hs-var">mkProjection</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (UTxOType tx)
forall a. Maybe a
</span><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TimedServerOutput tx -&gt; ServerOutput tx
forall tx. TimedServerOutput tx -&gt; ServerOutput tx
</span><a href="Hydra.API.ServerOutput.html#%24sel%3Aoutput%3ATimedServerOutput"><span class="hs-identifier hs-var">output</span></a></span><span> </span><span class="annot"><span class="annottext">(TimedServerOutput tx -&gt; ServerOutput tx)
-&gt; [TimedServerOutput tx] -&gt; [ServerOutput tx]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[TimedServerOutput tx]
</span><a href="#local-6989586621680250563"><span class="hs-identifier hs-var">timedOutputEvents</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe (UTxOType tx) -&gt; ServerOutput tx -&gt; Maybe (UTxOType tx)
forall tx.
Maybe (UTxOType tx) -&gt; ServerOutput tx -&gt; Maybe (UTxOType tx)
</span><a href="Hydra.API.ServerOutput.html#projectSnapshotUtxo"><span class="hs-identifier hs-var">projectSnapshotUtxo</span></a></span><span>
</span><span id="line-79"></span><span>    </span><span id="local-6989586621680250568"><span class="annot"><span class="annottext">Projection STM (ServerOutput tx) (Maybe HeadId)
</span><a href="#local-6989586621680250568"><span class="hs-identifier hs-var">headIdP</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe HeadId
-&gt; [ServerOutput tx]
-&gt; (Maybe HeadId -&gt; ServerOutput tx -&gt; Maybe HeadId)
-&gt; IO (Projection (STM IO) (ServerOutput tx) (Maybe HeadId))
forall (m :: * -&gt; *) model event.
MonadSTM m =&gt;
model
-&gt; [event]
-&gt; (model -&gt; event -&gt; model)
-&gt; m (Projection (STM m) event model)
</span><a href="Hydra.API.Projection.html#mkProjection"><span class="hs-identifier hs-var">mkProjection</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe HeadId
forall a. Maybe a
</span><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TimedServerOutput tx -&gt; ServerOutput tx
forall tx. TimedServerOutput tx -&gt; ServerOutput tx
</span><a href="Hydra.API.ServerOutput.html#%24sel%3Aoutput%3ATimedServerOutput"><span class="hs-identifier hs-var">output</span></a></span><span> </span><span class="annot"><span class="annottext">(TimedServerOutput tx -&gt; ServerOutput tx)
-&gt; [TimedServerOutput tx] -&gt; [ServerOutput tx]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">[TimedServerOutput tx]
</span><a href="#local-6989586621680250563"><span class="hs-identifier hs-var">timedOutputEvents</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Maybe HeadId -&gt; ServerOutput tx -&gt; Maybe HeadId
forall tx. Maybe HeadId -&gt; ServerOutput tx -&gt; Maybe HeadId
</span><a href="Hydra.API.ServerOutput.html#projectInitializingHeadId"><span class="hs-identifier hs-var">projectInitializingHeadId</span></a></span><span>
</span><span id="line-80"></span><span>
</span><span id="line-81"></span><span>    </span><span class="hs-comment">-- NOTE: we need to reverse the list because we store history in a reversed</span><span>
</span><span id="line-82"></span><span>    </span><span class="hs-comment">-- list in memory but in order on disk</span><span>
</span><span id="line-83"></span><span>    </span><span id="local-6989586621680250569"><span class="annot"><span class="annottext">TVar [TimedServerOutput tx]
</span><a href="#local-6989586621680250569"><span class="hs-identifier hs-var">history</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[TimedServerOutput tx] -&gt; IO (TVar [TimedServerOutput tx])
forall a. a -&gt; IO (TVar a)
</span><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Conc.Sync.html#newTVarIO"><span class="hs-identifier hs-var">newTVarIO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[TimedServerOutput tx] -&gt; [TimedServerOutput tx]
forall a. [a] -&gt; [a]
</span><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.List.html#reverse"><span class="hs-identifier hs-var">reverse</span></a></span><span> </span><span class="annot"><span class="annottext">[TimedServerOutput tx]
</span><a href="#local-6989586621680250563"><span class="hs-identifier hs-var">timedOutputEvents</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-84"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621680250571"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621680250571"><span class="hs-identifier hs-var">notifyServerRunning</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621680250572"><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621680250572"><span class="hs-identifier hs-var">waitForServerRunning</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (IO (), IO ())
</span><a href="Hydra.API.Server.html#setupServerNotification"><span class="hs-identifier hs-var">setupServerNotification</span></a></span><span>
</span><span id="line-85"></span><span>
</span><span id="line-86"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680250574"><span class="annot"><span class="annottext">serverSettings :: Settings
</span><a href="#local-6989586621680250574"><span class="hs-identifier hs-var hs-var">serverSettings</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-87"></span><span>          </span><span class="annot"><span class="annottext">Settings
</span><span class="hs-identifier hs-var">defaultSettings</span></span><span>
</span><span id="line-88"></span><span>            </span><span class="annot"><span class="annottext">Settings -&gt; (Settings -&gt; Settings) -&gt; Settings
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Function.html#%26"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">HostPreference -&gt; Settings -&gt; Settings
</span><span class="hs-identifier hs-var">setHost</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">String -&gt; HostPreference
forall a. IsString a =&gt; String -&gt; a
</span><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.String.html#fromString"><span class="hs-identifier hs-var">fromString</span></a></span><span> </span><span class="annot"><span class="annottext">(String -&gt; HostPreference) -&gt; String -&gt; HostPreference
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">IP -&gt; String
forall b a. (Show a, IsString b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">IP
</span><a href="#local-6989586621680250547"><span class="hs-identifier hs-var">host</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-89"></span><span>            </span><span class="annot"><span class="annottext">Settings -&gt; (Settings -&gt; Settings) -&gt; Settings
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Function.html#%26"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Port -&gt; Settings -&gt; Settings
</span><span class="hs-identifier hs-var">setPort</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PortNumber -&gt; Port
forall a b. (Integral a, Num b) =&gt; a -&gt; b
</span><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Real.html#fromIntegral"><span class="hs-identifier hs-var">fromIntegral</span></a></span><span> </span><span class="annot"><span class="annottext">PortNumber
</span><a href="#local-6989586621680250548"><span class="hs-identifier hs-var">port</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-90"></span><span>            </span><span class="annot"><span class="annottext">Settings -&gt; (Settings -&gt; Settings) -&gt; Settings
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Function.html#%26"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe Request -&gt; SomeException -&gt; IO ()) -&gt; Settings -&gt; Settings
</span><span class="hs-identifier hs-var">setOnException</span></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="annot"><span class="annottext">Maybe Request
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621680250577"><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621680250577"><span class="hs-identifier hs-var">e</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Tracer IO APIServerLog -&gt; APIServerLog -&gt; IO ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer IO APIServerLog
</span><a href="#local-6989586621680250555"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">(APIServerLog -&gt; IO ()) -&gt; APIServerLog -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><a href="Hydra.API.APIServerLog.html#APIConnectionError"><span class="hs-identifier hs-type">APIConnectionError</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">$sel:reason:APIServerStarted :: String
</span><a href="Hydra.API.APIServerLog.html#%24sel%3Areason%3AAPIServerStarted"><span class="hs-identifier hs-var">reason</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">SomeException -&gt; String
forall b a. (Show a, IsString b) =&gt; a -&gt; b
</span><span class="hs-identifier hs-var">show</span></span><span> </span><span class="annot"><span class="annottext">SomeException
</span><a href="#local-6989586621680250577"><span class="hs-identifier hs-var">e</span></a></span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-91"></span><span>            </span><span class="annot"><span class="annottext">Settings -&gt; (Settings -&gt; Settings) -&gt; Settings
forall a b. a -&gt; (a -&gt; b) -&gt; b
</span><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/Data.Function.html#%26"><span class="hs-operator hs-var">&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">IO () -&gt; Settings -&gt; Settings
</span><span class="hs-identifier hs-var">setBeforeMainLoop</span></span><span> </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621680250571"><span class="hs-identifier hs-var">notifyServerRunning</span></a></span><span>
</span><span id="line-92"></span><span>    </span><span class="annot"><span class="annottext">IO () -&gt; IO () -&gt; IO ()
forall a b. IO a -&gt; IO b -&gt; IO ()
forall (m :: * -&gt; *) a b. MonadAsync m =&gt; m a -&gt; m b -&gt; m ()
</span><span class="hs-identifier hs-var">race_</span></span><span>
</span><span id="line-93"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-94"></span><span>          </span><span class="annot"><span class="annottext">Tracer IO APIServerLog -&gt; APIServerLog -&gt; IO ()
forall (m :: * -&gt; *) a. Tracer m a -&gt; a -&gt; m ()
</span><span class="hs-identifier hs-var">traceWith</span></span><span> </span><span class="annot"><span class="annottext">Tracer IO APIServerLog
</span><a href="#local-6989586621680250555"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">PortNumber -&gt; APIServerLog
</span><a href="Hydra.API.APIServerLog.html#APIServerStarted"><span class="hs-identifier hs-var">APIServerStarted</span></a></span><span> </span><span class="annot"><span class="annottext">PortNumber
</span><a href="#local-6989586621680250548"><span class="hs-identifier hs-var">port</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-95"></span><span>          </span><span class="annot"><span class="annottext">Settings -&gt; Application -&gt; IO ()
</span><span class="hs-identifier hs-var">runSettings</span></span><span> </span><span class="annot"><span class="annottext">Settings
</span><a href="#local-6989586621680250574"><span class="hs-identifier hs-var">serverSettings</span></a></span><span> </span><span class="annot"><span class="annottext">(Application -&gt; IO ()) -&gt; Application -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-96"></span><span>            </span><span class="annot"><span class="annottext">ConnectionOptions -&gt; ServerApp -&gt; Application -&gt; Application
</span><span class="hs-identifier hs-var">websocketsOr</span></span><span>
</span><span id="line-97"></span><span>              </span><span class="annot"><span class="annottext">ConnectionOptions
</span><span class="hs-identifier hs-var">defaultConnectionOptions</span></span><span>
</span><span id="line-98"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Party
-&gt; Tracer IO APIServerLog
-&gt; TVar [TimedServerOutput tx]
-&gt; ServerCallback tx IO
-&gt; Projection STM (ServerOutput tx) HeadStatus
-&gt; Projection STM (ServerOutput tx) (Maybe (UTxOType tx))
-&gt; TChan (TimedServerOutput tx)
-&gt; ServerApp
forall tx.
IsChainState tx =&gt;
Party
-&gt; Tracer IO APIServerLog
-&gt; TVar [TimedServerOutput tx]
-&gt; (ClientInput tx -&gt; IO ())
-&gt; Projection STM (ServerOutput tx) HeadStatus
-&gt; Projection STM (ServerOutput tx) (Maybe (UTxOType tx))
-&gt; TChan (TimedServerOutput tx)
-&gt; ServerApp
</span><a href="Hydra.API.WSServer.html#wsApp"><span class="hs-identifier hs-var">wsApp</span></a></span><span> </span><span class="annot"><span class="annottext">Party
</span><a href="#local-6989586621680250549"><span class="hs-identifier hs-var">party</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO APIServerLog
</span><a href="#local-6989586621680250555"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">TVar [TimedServerOutput tx]
</span><a href="#local-6989586621680250569"><span class="hs-identifier hs-var">history</span></a></span><span> </span><span class="annot"><span class="annottext">ServerCallback tx IO
</span><a href="#local-6989586621680250558"><span class="hs-identifier hs-var">callback</span></a></span><span> </span><span class="annot"><span class="annottext">Projection STM (ServerOutput tx) HeadStatus
</span><a href="#local-6989586621680250564"><span class="hs-identifier hs-var">headStatusP</span></a></span><span> </span><span class="annot"><span class="annottext">Projection STM (ServerOutput tx) (Maybe (UTxOType tx))
</span><a href="#local-6989586621680250567"><span class="hs-identifier hs-var">snapshotUtxoP</span></a></span><span> </span><span class="annot"><span class="annottext">TChan (TimedServerOutput tx)
</span><a href="#local-6989586621680250562"><span class="hs-identifier hs-var">responseChannel</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-99"></span><span>              </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Tracer IO APIServerLog
-&gt; Chain tx IO
-&gt; PParams LedgerEra
-&gt; STM IO (Maybe HeadId)
-&gt; Application
forall tx.
Tracer IO APIServerLog
-&gt; Chain tx IO
-&gt; PParams LedgerEra
-&gt; STM IO (Maybe HeadId)
-&gt; Application
</span><a href="Hydra.API.HTTPServer.html#httpApp"><span class="hs-identifier hs-var">httpApp</span></a></span><span> </span><span class="annot"><span class="annottext">Tracer IO APIServerLog
</span><a href="#local-6989586621680250555"><span class="hs-identifier hs-var">tracer</span></a></span><span> </span><span class="annot"><span class="annottext">Chain tx IO
</span><a href="#local-6989586621680250556"><span class="hs-identifier hs-var">chain</span></a></span><span> </span><span class="annot"><span class="annottext">PParams LedgerEra
</span><a href="#local-6989586621680250557"><span class="hs-identifier hs-var">pparams</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Projection STM (ServerOutput tx) (Maybe HeadId)
-&gt; STM (Maybe HeadId)
forall (stm :: * -&gt; *) event model.
Projection stm event model -&gt; stm model
</span><a href="Hydra.API.Projection.html#%24sel%3AgetLatest%3AProjection"><span class="hs-identifier hs-var">getLatest</span></a></span><span> </span><span class="annot"><span class="annottext">Projection STM (ServerOutput tx) (Maybe HeadId)
</span><a href="#local-6989586621680250568"><span class="hs-identifier hs-var">headIdP</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-100"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-101"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-102"></span><span>          </span><span class="annot"><span class="annottext">IO ()
</span><a href="#local-6989586621680250572"><span class="hs-identifier hs-var">waitForServerRunning</span></a></span><span>
</span><span id="line-103"></span><span>          </span><span class="annot"><span class="annottext">Server tx IO -&gt; IO ()
</span><a href="#local-6989586621680250559"><span class="hs-identifier hs-var">action</span></a></span><span> </span><span class="annot"><span class="annottext">(Server tx IO -&gt; IO ()) -&gt; Server tx IO -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-104"></span><span>            </span><span class="annot"><a href="Hydra.API.Server.html#Server"><span class="hs-identifier hs-type">Server</span></a></span><span>
</span><span id="line-105"></span><span>              </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">$sel:sendOutput:Server :: ServerOutput tx -&gt; IO ()
</span><a href="Hydra.API.Server.html#%24sel%3AsendOutput%3AServer"><span class="hs-identifier hs-var">sendOutput</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621680250583"><span class="annot"><span class="annottext">ServerOutput tx
</span><a href="#local-6989586621680250583"><span class="hs-identifier hs-var">output</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-106"></span><span>                  </span><span id="local-6989586621680250584"><span class="annot"><span class="annottext">TimedServerOutput tx
</span><a href="#local-6989586621680250584"><span class="hs-identifier hs-var">timedOutput</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar [TimedServerOutput tx]
-&gt; ServerOutput tx -&gt; IO (TimedServerOutput tx)
</span><a href="#local-6989586621680250585"><span class="hs-identifier hs-var">appendToHistory</span></a></span><span> </span><span class="annot"><span class="annottext">TVar [TimedServerOutput tx]
</span><a href="#local-6989586621680250569"><span class="hs-identifier hs-var">history</span></a></span><span> </span><span class="annot"><span class="annottext">ServerOutput tx
</span><a href="#local-6989586621680250583"><span class="hs-identifier hs-var">output</span></a></span><span>
</span><span id="line-107"></span><span>                  </span><span class="annot"><span class="annottext">STM IO () -&gt; IO ()
forall a. HasCallStack =&gt; STM IO a -&gt; IO a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM IO () -&gt; IO ()) -&gt; STM IO () -&gt; IO ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-108"></span><span>                    </span><span class="annot"><span class="annottext">Projection STM (ServerOutput tx) HeadStatus
-&gt; ServerOutput tx -&gt; STM ()
forall (stm :: * -&gt; *) event model.
Projection stm event model -&gt; event -&gt; stm ()
</span><a href="Hydra.API.Projection.html#%24sel%3Aupdate%3AProjection"><span class="hs-identifier hs-var">update</span></a></span><span> </span><span class="annot"><span class="annottext">Projection STM (ServerOutput tx) HeadStatus
</span><a href="#local-6989586621680250564"><span class="hs-identifier hs-var">headStatusP</span></a></span><span> </span><span class="annot"><span class="annottext">ServerOutput tx
</span><a href="#local-6989586621680250583"><span class="hs-identifier hs-var">output</span></a></span><span>
</span><span id="line-109"></span><span>                    </span><span class="annot"><span class="annottext">Projection STM (ServerOutput tx) (Maybe (UTxOType tx))
-&gt; ServerOutput tx -&gt; STM ()
forall (stm :: * -&gt; *) event model.
Projection stm event model -&gt; event -&gt; stm ()
</span><a href="Hydra.API.Projection.html#%24sel%3Aupdate%3AProjection"><span class="hs-identifier hs-var">update</span></a></span><span> </span><span class="annot"><span class="annottext">Projection STM (ServerOutput tx) (Maybe (UTxOType tx))
</span><a href="#local-6989586621680250567"><span class="hs-identifier hs-var">snapshotUtxoP</span></a></span><span> </span><span class="annot"><span class="annottext">ServerOutput tx
</span><a href="#local-6989586621680250583"><span class="hs-identifier hs-var">output</span></a></span><span>
</span><span id="line-110"></span><span>                    </span><span class="annot"><span class="annottext">Projection STM (ServerOutput tx) (Maybe HeadId)
-&gt; ServerOutput tx -&gt; STM ()
forall (stm :: * -&gt; *) event model.
Projection stm event model -&gt; event -&gt; stm ()
</span><a href="Hydra.API.Projection.html#%24sel%3Aupdate%3AProjection"><span class="hs-identifier hs-var">update</span></a></span><span> </span><span class="annot"><span class="annottext">Projection STM (ServerOutput tx) (Maybe HeadId)
</span><a href="#local-6989586621680250568"><span class="hs-identifier hs-var">headIdP</span></a></span><span> </span><span class="annot"><span class="annottext">ServerOutput tx
</span><a href="#local-6989586621680250583"><span class="hs-identifier hs-var">output</span></a></span><span>
</span><span id="line-111"></span><span>                    </span><span class="annot"><span class="annottext">TChan (TimedServerOutput tx) -&gt; TimedServerOutput tx -&gt; STM ()
forall a. TChan a -&gt; a -&gt; STM ()
</span><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/stm-2.5.1.0/src/Control.Concurrent.STM.TChan.html#writeTChan"><span class="hs-identifier hs-var">writeTChan</span></a></span><span> </span><span class="annot"><span class="annottext">TChan (TimedServerOutput tx)
</span><a href="#local-6989586621680250562"><span class="hs-identifier hs-var">responseChannel</span></a></span><span> </span><span class="annot"><span class="annottext">TimedServerOutput tx
</span><a href="#local-6989586621680250584"><span class="hs-identifier hs-var">timedOutput</span></a></span><span>
</span><span id="line-112"></span><span>              </span><span class="hs-special">}</span><span>
</span><span id="line-113"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-114"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-115"></span><span>  </span><span id="local-6989586621680250585"><span class="annot"><span class="annottext">appendToHistory :: TVar [TimedServerOutput tx]
-&gt; ServerOutput tx -&gt; IO (TimedServerOutput tx)
</span><a href="#local-6989586621680250585"><span class="hs-identifier hs-var hs-var">appendToHistory</span></a></span></span><span> </span><span id="local-6989586621680250588"><span class="annot"><span class="annottext">TVar [TimedServerOutput tx]
</span><a href="#local-6989586621680250588"><span class="hs-identifier hs-var">history</span></a></span></span><span> </span><span id="local-6989586621680250589"><span class="annot"><span class="annottext">ServerOutput tx
</span><a href="#local-6989586621680250589"><span class="hs-identifier hs-var">output</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-116"></span><span>    </span><span id="local-6989586621680250590"><span class="annot"><span class="annottext">UTCTime
</span><a href="#local-6989586621680250590"><span class="hs-identifier hs-var">time</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO UTCTime
forall (m :: * -&gt; *). MonadTime m =&gt; m UTCTime
</span><span class="hs-identifier hs-var">getCurrentTime</span></span><span>
</span><span id="line-117"></span><span>    </span><span id="local-6989586621680250592"><span class="annot"><span class="annottext">TimedServerOutput tx
</span><a href="#local-6989586621680250592"><span class="hs-identifier hs-var">timedOutput</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">STM IO (TimedServerOutput tx) -&gt; IO (TimedServerOutput tx)
forall a. HasCallStack =&gt; STM IO a -&gt; IO a
forall (m :: * -&gt; *) a.
(MonadSTM m, HasCallStack) =&gt;
STM m a -&gt; m a
</span><span class="hs-identifier hs-var">atomically</span></span><span> </span><span class="annot"><span class="annottext">(STM IO (TimedServerOutput tx) -&gt; IO (TimedServerOutput tx))
-&gt; STM IO (TimedServerOutput tx) -&gt; IO (TimedServerOutput tx)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-118"></span><span>      </span><span id="local-6989586621680250593"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621680250593"><span class="hs-identifier hs-var">seq</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">TVar [TimedServerOutput tx] -&gt; STM Natural
forall tx. TVar [TimedServerOutput tx] -&gt; STM Natural
</span><a href="Hydra.API.WSServer.html#nextSequenceNumber"><span class="hs-identifier hs-var">nextSequenceNumber</span></a></span><span> </span><span class="annot"><span class="annottext">TVar [TimedServerOutput tx]
</span><a href="#local-6989586621680250588"><span class="hs-identifier hs-var">history</span></a></span><span>
</span><span id="line-119"></span><span>      </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621680250594"><span class="annot"><span class="annottext">timedOutput :: TimedServerOutput tx
</span><a href="#local-6989586621680250594"><span class="hs-identifier hs-var hs-var">timedOutput</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Hydra.API.ServerOutput.html#TimedServerOutput"><span class="hs-identifier hs-type">TimedServerOutput</span></a></span><span class="hs-special">{</span><span class="annot"><span class="annottext">ServerOutput tx
$sel:output:TimedServerOutput :: ServerOutput tx
output :: ServerOutput tx
</span><a href="Hydra.API.ServerOutput.html#%24sel%3Aoutput%3ATimedServerOutput"><span class="hs-identifier hs-var hs-var">output</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UTCTime
time :: UTCTime
$sel:time:TimedServerOutput :: UTCTime
</span><a href="#local-6989586621680250590"><span class="hs-identifier hs-var hs-var">time</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Natural
seq :: Natural
$sel:seq:TimedServerOutput :: Natural
</span><a href="#local-6989586621680250593"><span class="hs-identifier hs-var hs-var">seq</span></a></span><span class="hs-special">}</span><span>
</span><span id="line-120"></span><span>      </span><span class="annot"><span class="annottext">TVar [TimedServerOutput tx]
-&gt; ([TimedServerOutput tx] -&gt; [TimedServerOutput tx]) -&gt; STM ()
forall a. TVar a -&gt; (a -&gt; a) -&gt; STM ()
</span><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/stm-2.5.1.0/src/Control.Concurrent.STM.TVar.html#modifyTVar%27"><span class="hs-identifier hs-var">modifyTVar'</span></a></span><span> </span><span class="annot"><span class="annottext">TVar [TimedServerOutput tx]
</span><a href="#local-6989586621680250588"><span class="hs-identifier hs-var">history</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">TimedServerOutput tx
</span><a href="#local-6989586621680250594"><span class="hs-identifier hs-var">timedOutput</span></a></span><span> </span><span class="hs-glyph">:</span><span class="hs-special">)</span><span>
</span><span id="line-121"></span><span>      </span><span class="annot"><span class="annottext">TimedServerOutput tx -&gt; STM (TimedServerOutput tx)
forall a. a -&gt; STM a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">TimedServerOutput tx
</span><a href="#local-6989586621680250594"><span class="hs-identifier hs-var">timedOutput</span></a></span><span>
</span><span id="line-122"></span><span>    </span><span class="annot"><span class="annottext">ToJSON (TimedServerOutput tx) =&gt; TimedServerOutput tx -&gt; IO ()
TimedServerOutput tx -&gt; IO ()
</span><a href="#local-6989586621680250553"><span class="hs-identifier hs-var">append</span></a></span><span> </span><span class="annot"><span class="annottext">TimedServerOutput tx
</span><a href="#local-6989586621680250592"><span class="hs-identifier hs-var">timedOutput</span></a></span><span>
</span><span id="line-123"></span><span>    </span><span class="annot"><span class="annottext">TimedServerOutput tx -&gt; IO (TimedServerOutput tx)
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">TimedServerOutput tx
</span><a href="#local-6989586621680250592"><span class="hs-identifier hs-var">timedOutput</span></a></span><span>
</span><span id="line-124"></span><span>
</span><span id="line-125"></span><span>  </span><span id="local-6989586621680250561"><span class="annot"><span class="annottext">onIOException :: IOException -&gt; IO ()
</span><a href="#local-6989586621680250561"><span class="hs-identifier hs-var hs-var">onIOException</span></a></span></span><span> </span><span id="local-6989586621680250598"><span class="annot"><span class="annottext">IOException
</span><a href="#local-6989586621680250598"><span class="hs-identifier hs-var">ioException</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-126"></span><span>    </span><span class="annot"><span class="annottext">RunServerException -&gt; IO ()
forall e a. Exception e =&gt; e -&gt; IO a
forall (m :: * -&gt; *) e a. (MonadThrow m, Exception e) =&gt; e -&gt; m a
</span><span class="hs-identifier hs-var">throwIO</span></span><span>
</span><span id="line-127"></span><span>      </span><span class="annot"><a href="Hydra.API.Server.html#RunServerException"><span class="hs-identifier hs-type">RunServerException</span></a></span><span>
</span><span id="line-128"></span><span>        </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">IOException
ioException :: IOException
$sel:ioException:RunServerException :: IOException
</span><a href="#local-6989586621680250598"><span class="hs-identifier hs-var hs-var">ioException</span></a></span><span>
</span><span id="line-129"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IP
host :: IP
$sel:host:RunServerException :: IP
</span><a href="#local-6989586621680250547"><span class="hs-identifier hs-var hs-var">host</span></a></span><span>
</span><span id="line-130"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">PortNumber
port :: PortNumber
$sel:port:RunServerException :: PortNumber
</span><a href="#local-6989586621680250548"><span class="hs-identifier hs-var hs-var">port</span></a></span><span>
</span><span id="line-131"></span><span>        </span><span class="hs-special">}</span><span>
</span><span id="line-132"></span><span>
</span><span id="line-133"></span><span class="annot"><span class="hs-comment">-- | An 'IOException' with more 'IP' and 'PortNumber' added as context.</span></span><span>
</span><span id="line-134"></span><span class="hs-keyword">data</span><span> </span><span id="RunServerException"><span class="annot"><a href="Hydra.API.Server.html#RunServerException"><span class="hs-identifier hs-var">RunServerException</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="RunServerException"><span class="annot"><a href="Hydra.API.Server.html#RunServerException"><span class="hs-identifier hs-var">RunServerException</span></a></span></span><span>
</span><span id="line-135"></span><span>  </span><span class="hs-special">{</span><span> </span><span id="%24sel%3AioException%3ARunServerException"><span class="annot"><span class="annottext">RunServerException -&gt; IOException
</span><a href="Hydra.API.Server.html#%24sel%3AioException%3ARunServerException"><span class="hs-identifier hs-var hs-var">ioException</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.IO.Exception.html#IOException"><span class="hs-identifier hs-type">IOException</span></a></span><span>
</span><span id="line-136"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="%24sel%3Ahost%3ARunServerException"><span class="annot"><span class="annottext">RunServerException -&gt; IP
</span><a href="Hydra.API.Server.html#%24sel%3Ahost%3ARunServerException"><span class="hs-identifier hs-var hs-var">host</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IP</span></span><span>
</span><span id="line-137"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="%24sel%3Aport%3ARunServerException"><span class="annot"><span class="annottext">RunServerException -&gt; PortNumber
</span><a href="Hydra.API.Server.html#%24sel%3Aport%3ARunServerException"><span class="hs-identifier hs-var hs-var">port</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">PortNumber</span></span><span>
</span><span id="line-138"></span><span>  </span><span class="hs-special">}</span><span>
</span><span id="line-139"></span><span>  </span><span class="hs-keyword">deriving</span><span> </span><span class="annot"><span class="hs-keyword">stock</span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621680250605"><span id="local-6989586621680250614"><span id="local-6989586621680250618"><span class="annot"><span class="annottext">Port -&gt; RunServerException -&gt; ShowS
[RunServerException] -&gt; ShowS
RunServerException -&gt; String
(Port -&gt; RunServerException -&gt; ShowS)
-&gt; (RunServerException -&gt; String)
-&gt; ([RunServerException] -&gt; ShowS)
-&gt; Show RunServerException
forall a.
(Port -&gt; a -&gt; ShowS) -&gt; (a -&gt; String) -&gt; ([a] -&gt; ShowS) -&gt; Show a
$cshowsPrec :: Port -&gt; RunServerException -&gt; ShowS
showsPrec :: Port -&gt; RunServerException -&gt; ShowS
$cshow :: RunServerException -&gt; String
show :: RunServerException -&gt; String
$cshowList :: [RunServerException] -&gt; ShowS
showList :: [RunServerException] -&gt; ShowS
</span><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Show.html#Show"><span class="hs-identifier hs-var hs-var hs-var hs-var hs-var hs-var hs-var hs-var">Show</span></a></span></span></span></span><span class="hs-special">)</span><span>
</span><span id="line-140"></span><span>
</span><span id="line-141"></span><span class="hs-keyword">instance</span><span> </span><span id="local-6989586621680250626"><span id="local-6989586621680250629"><span id="local-6989586621680250632"><span class="annot"><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Exception.Type.html#Exception"><span class="hs-identifier hs-type">Exception</span></a></span><span> </span><span class="annot"><a href="Hydra.API.Server.html#RunServerException"><span class="hs-identifier hs-type">RunServerException</span></a></span></span></span></span><span>
</span><span id="line-142"></span><span>
</span><span id="line-143"></span><span class="hs-keyword">type</span><span> </span><span id="NotifyServerRunning"><span class="annot"><a href="Hydra.API.Server.html#NotifyServerRunning"><span class="hs-identifier hs-var">NotifyServerRunning</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-144"></span><span>
</span><span id="line-145"></span><span class="hs-keyword">type</span><span> </span><span id="WaitForServer"><span class="annot"><a href="Hydra.API.Server.html#WaitForServer"><span class="hs-identifier hs-var">WaitForServer</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-146"></span><span>
</span><span id="line-147"></span><span class="hs-comment">-- | Setup notification and waiter to ensure that something only runs after the</span><span>
</span><span id="line-148"></span><span class="hs-comment">-- server is actually listening.</span><span>
</span><span id="line-149"></span><span class="annot"><a href="Hydra.API.Server.html#setupServerNotification"><span class="hs-identifier hs-type">setupServerNotification</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/ghc-prim-0.10.0/src/GHC.Types.html#IO"><span class="hs-identifier hs-type">IO</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="Hydra.API.Server.html#NotifyServerRunning"><span class="hs-identifier hs-type">NotifyServerRunning</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Hydra.API.Server.html#WaitForServer"><span class="hs-identifier hs-type">WaitForServer</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-150"></span><span id="setupServerNotification"><span class="annot"><span class="annottext">setupServerNotification :: IO (IO (), IO ())
</span><a href="Hydra.API.Server.html#setupServerNotification"><span class="hs-identifier hs-var hs-var">setupServerNotification</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-151"></span><span>  </span><span id="local-6989586621680250637"><span class="annot"><span class="annottext">MVar ()
</span><a href="#local-6989586621680250637"><span class="hs-identifier hs-var">mv</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">IO (MVar ())
forall a. IO (MVar a)
</span><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.MVar.html#newEmptyMVar"><span class="hs-identifier hs-var">newEmptyMVar</span></a></span><span>
</span><span id="line-152"></span><span>  </span><span class="annot"><span class="annottext">(IO (), IO ()) -&gt; IO (IO (), IO ())
forall a. a -&gt; IO a
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MVar () -&gt; () -&gt; IO ()
forall a. MVar a -&gt; a -&gt; IO ()
</span><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.MVar.html#putMVar"><span class="hs-identifier hs-var">putMVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar ()
</span><a href="#local-6989586621680250637"><span class="hs-identifier hs-var">mv</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MVar () -&gt; IO ()
forall a. MVar a -&gt; IO a
</span><a href="file:///nix/store/g7is9c8iy7mij0yvra8lrlqi9y5mmkkj-ghc-9.6.3-doc/share/doc/ghc-9.6.3/html/libraries/base-4.18.1.0/src/GHC.MVar.html#takeMVar"><span class="hs-identifier hs-var">takeMVar</span></a></span><span> </span><span class="annot"><span class="annottext">MVar ()
</span><a href="#local-6989586621680250637"><span class="hs-identifier hs-var">mv</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-153"></span></pre></body></html>